---
title: "COVID-19 Sonora"
output: 
  flexdashboard::flex_dashboard:
    theme: cosmo
    social: [ "menu"]
    orientation: rows
    vertical_layout: fill
    favicon: favicon-mcd.png

---

<!-- Copyright (c) 2020 Universidad de Sonora -->

<!-- Por la presente se concede permiso, libre de cargos, a cualquier persona que obtenga una copia de este software y de los archivos de documentación asociados (el "Software"), a utilizar el Software sin restricción, incluyendo sin limitación los derechos a usar, copiar, modificar, fusionar, publicar, distribuir, sublicenciar, y/o vender copias del Software, y a permitir a las personas a las que se les proporcione el Software a hacer lo mismo, sujeto a las siguientes condiciones: -->
<!-- El aviso de copyright anterior y este aviso de permiso se incluirán en todas las copias o partes sustanciales del Software. -->

<!-- EL SOFTWARE SE PROPORCIONA "COMO ESTÁ", SIN GARANTÍA DE NINGÚN TIPO, EXPRESA O IMPLÍCITA, INCLUYENDO PERO NO LIMITADO A GARANTÍAS DE COMERCIALIZACIÓN, IDONEIDAD PARA UN PROPÓSITO PARTICULAR E INCUMPLIMIENTO. EN NINGÚN CASO LOS AUTORES O PROPIETARIOS DE LOS DERECHOS DE AUTOR SERÁN RESPONSABLES DE NINGUNA RECLAMACIÓN, DAÑOS U OTRAS RESPONSABILIDADES, YA SEA EN UNA ACCIÓN DE CONTRATO, AGRAVIO O CUALQUIER OTRO MOTIVO, DERIVADAS DE, FUERA DE O EN CONEXIÓN CON EL SOFTWARE O SU USO U OTRO TIPO DE ACCIONES EN EL SOFTWARE. -->


```{r setup, include=FALSE}
#------------------ Packages ------------------
library(flexdashboard)
library(tidyverse)
library(magrittr)


#--------------------Configuraciones generales---------------
dir.danica <- paste("../data/BASE COVID-19-19.NOV.20-BM.xlsx")
carranco <- TRUE

# El dia de hoy (para los archivos)
hoy <- Sys.Date() - 1
hoy.jh <- format(hoy, "%m-%d-%Y")
inicio.hospitaizados <- as.Date("2020-08-05")
dia <- as.Date("2020-04-07")


# Fecha inicial para las gráficas de tendencias
inicio.tendencias <- as.Date("2020-05-01")

# Colores 
# https://www.w3.org/TR/css-color-3/#svg-color
confirmados_color <- "purple"
activos_color <- "#0000CD"
recuperados_color <- "#46B861"
decesos_color <- "darkgrey"
rosa_color <- "#FF1493"
seg_term.color <- "green"

#------------Funcion de medias moviles-------------
ma <- function(arr, n=7){
  res = arr
  for(i in n:length(arr)){
    res[i- integer(n/2)] = mean(arr[(i-n):i], na.rm = TRUE)
  }
  res
}


#--------------Los datos de SSA-------------

df.denica <- readxl::read_xlsx(dir.danica)
df.extracto <- df.denica %>%
  group_by(`MUN RES`) %>%
  summarise(
    `Pruebas en proceso` = sum(is.na(RESDEFIN)),
    Confirmados = sum(grepl("SARS-CoV", RESDEFIN)) + sum(grepl("ASOCIA", RESDEFIN)),
    Negativos = sum(!grepl("SARS-CoV", RESDEFIN) & !is.na(RESDEFIN))
  ) %>%
  rename(Municipio = `MUN RES`)

#--------------- Datos Arizona de la JHU------------------

direccion <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/"

df_az <- read.csv(paste(direccion, hoy.jh, '.csv', sep=''), stringsAsFactors = FALSE) %>%
  filter( 
    Province_State %in% c('Arizona', 'Nacional')
  ) %>%
  mutate(Fecha = as.Date(Last_Update, format="%m/%d/%y %h:%m")) %>%
  rename(
    Municipio = Admin2,
    Pais = Country_Region, 
    Estado = Province_State,
    Confirmados = Confirmed,
    Recuperados = Recovered,
    Decesos = Deaths,
    Activos = Active,
    Long = Long_
  ) %>%
  select(
    -FIPS, -Combined_Key, -Last_Update
  )

#---------------Nacional-------------------------

if (carranco){
  # De Carranco
  dir.carranco <- paste("https://raw.githubusercontent.com/carranco-sga/Mexico-COVID-19/master/Mexico_COVID19_CTD.csv")
  df.carranco <- read.csv(dir.carranco, stringsAsFactors = FALSE)

  df.mex.conf <- df.carranco %>%
    mutate(
      Fecha = as.Date(Fecha),
      Sinaloa = SIN,
      Baja.California = BCN,
      Chihuahua = CHH,
      Nacional = Pos
    ) %>%
    select(Fecha, Sinaloa, Chihuahua, Baja.California, Nacional)

  df.mex.dec <- df.carranco %>%
    mutate(
      Fecha = as.Date(Fecha),
      Sinaloa = SIN_D,
      Baja.California = BCN_D,
      Chihuahua = CHH_D,
      Nacional = Deceased
    ) %>%
    select(Fecha, Sinaloa, Chihuahua, Baja.California, Nacional)
} else{
  # De méxico-covid
  dir.mex.con = paste("https://raw.githubusercontent.com/mexicovid19/Mexico-datos/master/datos/series_de_tiempo/covid19_mex_casos_totales.csv")
  dir.mex.dec = paste("https://raw.githubusercontent.com/mexicovid19/Mexico-datos/master/datos/series_de_tiempo/covid19_mex_muertes.csv")

  df.mex.conf <- read.csv(dir.mex.con, stringsAsFactors = FALSE) %>% mutate(Fecha=as.Date(Fecha))
  df.mex.dec <- read.csv(dir.mex.dec, stringsAsFactors = FALSE) %>% mutate(Fecha=as.Date(Fecha))
}

#--------------- Datos de Sonora y sus Municipios -------------

df_mio <- read.csv("../data/acumulado.csv", stringsAsFactors = FALSE)
df_son_c <- df_mio %>% filter(Municipio == "Estado") %>% 
  mutate(Estado = "Sonora") %>%
    select(Estado, Confirmados, Recuperados, Decesos)
df_municipios <- df_mio %>% filter(Municipio != "Estado") %>% 
    select(Municipio, Confirmados, Decesos, Recuperados)

#----------------Concentrado general -----------------------------

df_c <- data.frame(
  Estado = c('Sonora', 'Chihuahua', 'Sinaloa', 'Baja California'),
  Confirmados = c(df_son_c$Confirmados, 
                  last(df.mex.conf$Chihuahua), 
                  last(df.mex.conf$Sinaloa),
                  last(df.mex.conf$Baja.California)),
  Decesos = c(df_son_c$Decesos, 
              last(df.mex.dec$Chihuahua), 
              last(df.mex.dec$Sinaloa),
              last(df.mex.dec$Baja.California)),
  Recuperados = c(df_son_c$Recuperados, NA, NA, NA)
)

#----------------Series de tiempo de confrmados----------------------

df.son <- read.csv("../data/serie-confirmados.csv", stringsAsFactors = FALSE) %>%
  mutate(Fecha = as.Date(Fecha, "%d/%m/%y")) %>% rename(Sonora = "Confirmados")

dir_az_s <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv"

temp <- read.csv(dir_az_s, check.names=FALSE, stringsAsFactors=FALSE) 
n = length(names(temp))
if (names(temp)[n] == names(temp)[n-1]){
  temp <- temp %>% select(-n)
}

df_az_s <- temp %>%
  select(-(1:6), -(8:11) ) %>%
  filter(`Province_State` == "Arizona") %>%
  pivot_longer(
    cols = -`Province_State`,
    names_to = "Fecha",
    values_to = "Arizona"
  ) %>%
  select(-`Province_State`) %>%
  mutate(Fecha = as.Date(Fecha, "%m/%d/%y")) %>%
  group_by(Fecha) %>%
  summarise(Arizona = sum(Arizona, na.rm = TRUE)) %>%
  filter(Fecha >= "2020-3-17")

df.estados.serie <- df.mex.conf %>%
  select(Fecha, Nacional, Chihuahua, Sinaloa, Baja.California) %>%
  rename(`Baja California` = Baja.California)

df_s <- df.son %>% 
  left_join(df.estados.serie, by = "Fecha") %>%
  left_join(df_az_s, by = "Fecha") 


fecha <- c()
Defunciones <- c()
Pruebas <- c()
Positivos <- c()
Recuperados <- c()

while( dia <= hoy){
  tmp <- read.csv(paste("../data/acc/acumulado-", format(dia, "%d-%m-%Y"), ".csv", sep=''))
  fecha <- append(fecha, dia)
  Defunciones <- append( Defunciones, last(tmp$Decesos))
  Pruebas <- append( Pruebas, last(tmp$Estudiados))
  Positivos <- append( Positivos, last(tmp$Confirmados))
  Recuperados <- append(Recuperados, last(tmp$Recuperados))
  dia <- dia + 1
}

df.tend <- data.frame(
  Fecha = fecha,
  Defunciones = Defunciones,
  Pruebas = Pruebas,
  Positivos = Positivos
) %>%
  mutate(
    Activos = Positivos - Defunciones - Recuperados,
    Positividad = format( 100 * Positivos / Pruebas, digits = 2),
    Letalidad = format(100 * Defunciones / Positivos, digits = 3)
  )


#------------------Series por municipio a partir de accumulados---------------
# Debe haber una manera menos fea de programarlo, me falta saber mucho de R
dia <- as.Date(hoy-70)
# dia <- as.Date("2020-04-07") + 1
tmp <- read.csv(paste("../data/acc/acumulado-", format(dia, "%d-%m-%Y"), 
                      ".csv", sep=''))
df.acc <- data.frame(
  Municipio = tmp$Municipio, 
  Confirmados = tmp$Confirmados,
  Decesos = tmp$Decesos,
  Fecha = dia
)
dia <- dia + 1
while( dia <= hoy){
  tmp <- read.csv(paste("../data/acc/acumulado-", format(dia, "%d-%m-%Y"), 
                        ".csv", sep=''))
  df.acc <- bind_rows(
    df.acc,
    data.frame(
      Municipio = tmp$Municipio, 
      Confirmados = tmp$Confirmados,
      Decesos = tmp$Decesos,
      Fecha = dia
    )
  )
  dia <- dia + 1
}
df.mun.con <- df.acc %>% 
  select(-Decesos) %>% 
  pivot_wider(names_from = Municipio, values_from = Confirmados, values_fill = 0)
df.mun.dec <- df.acc %>% 
  select(-Confirmados) %>% 
  pivot_wider(names_from = Municipio, values_from = Decesos, values_fill = 0)

fdf <- function(serie){
  serie - lag(serie)
}

df.evol <- data.frame( 
  Fecha = df.mun.con$Fecha,
  Sonora.confirmados = fdf(df.mun.con$Estado),
  Sonora.decesos = fdf(df.mun.dec$Estado),
  Hillo.confirmados = fdf(df.mun.con$HERMOSILLO),
  Hillo.decesos = fdf(df.mun.dec$HERMOSILLO),
  SLRC.confirmados = fdf(df.mun.con$`SAN LUIS RIO COLORADO`),
  SLRC.decesos = fdf(df.mun.dec$`SAN LUIS RIO COLORADO`),
  Cajeme.confirmados = fdf(df.mun.con$CAJEME),
  Cajeme.decesos = fdf(df.mun.dec$CAJEME),
  Nogales.confirmados = fdf(df.mun.con$NOGALES),
  Nogales.decesos = fdf(df.mun.dec$NOGALES),
  Navojoa.confirmados = fdf(df.mun.con$NAVOJOA),
  Navojoa.decesos = fdf(df.mun.dec$NAVOJOA),
  Caborca.confirmados = fdf(df.mun.con$CABORCA),
  Caborca.decesos = fdf(df.mun.dec$CABORCA),
  Guaymas.confirmados = fdf(df.mun.con$GUAYMAS),
  Guaymas.decesos = fdf(df.mun.dec$GUAYMAS),
  AP.confirmados = fdf(df.mun.con$`AGUA PRIETA`),
  AP.decesos = fdf(df.mun.dec$`AGUA PRIETA`)
) 
df.evol <- left_join(
  df.evol,
  select(df.tend, Fecha, Pruebas)
)

write.csv(df.acc, "../Datos-Covid19/por_fecha_publicacion.csv")


```

Resumen
=======================================================================

Row
-----------------------------------------------------------------------

### Confirmados {.value-box}

```{r}
valueBox(
  value = paste(format(df_c$Confirmados[df_c$Estado=="Sonora"], big.mark = ","), "", sep = " "), 
  caption = "Confirmados", 
  icon = "fas fa-thermometer-full", 
  color = confirmados_color
)
```



### Activos {.value-box}

```{r}
valueBox(
  value = paste(
    format(
      (last(df_mio$Confirmados) - last(df_mio$Recuperados) -
       last(df_mio$Seguimiento.terminado) - last(df_mio$Decesos)), 
      big.mark = ","
    ), 
    "", sep = " "
  ), 
  caption = "Activos", 
  icon = "fas fa-medkit", 
  color = activos_color)
```


### Seguimiento terminado {.value-box}

```{r}
valueBox(
  value = paste(
    format(
      last(df_mio$Seguimiento.terminado), 
      big.mark = ","
    ), 
    "", sep = " "
  ), 
  caption = "Seguimiento terminado", 
  icon = "fas fa-medkit", 
  color = seg_term.color)
```


### Recuperados {.value-box}

```{r}
valueBox(
  value = paste(format(df_son_c$Recuperados, big.mark = ","), "", sep = ""), 
  caption = "Recuperados", 
  icon = "fas fa-thumbs-up", 
  color = recuperados_color
)
```

### Decesos {.value-box}

```{r}

valueBox(
  value = paste(format(df_c$Decesos[df_c$Estado=="Sonora"], big.mark = ","), "", sep = " "),
  caption = "Decesos", 
  icon = "fas fa-plus-square", 
  color = decesos_color
)
```

<!-- ###  -->
<!-- ```{r out.width="10%"} -->
<!-- knitr::include_graphics("escudo.png") -->
<!-- ``` -->




Row 
-----------------------------------------------------------------------

### **Casos Confirmados**

```{r daily_summary}

df_pp <- df_c %>%
  dplyr::filter(Estado %in% c("Sonora", "Chihuahua", "Baja California", "Sinaloa")) 
df_pp$activos = NA
df_pp$activos[df_pp$Estado=="Sonora"] = (last(df_mio$Confirmados) - 
                                          last(df_mio$Recuperados)-
                                          last(df_mio$Seguimiento.terminado) - 
                                          last(df_mio$Decesos))
df_pp$seg.term = NA
df_pp$seg.term[df_pp$Estado=="Sonora"] = last(df_mio$Seguimiento.terminado)

plotly::plot_ly(data = df_pp, 
                x = ~ reorder(Estado, Confirmados), 
                y = ~ (ifelse(is.na(Recuperados), Confirmados - Decesos, NA)), 
                type = "bar", 
                name = "Confirmados",
                marker = list(color = confirmados_color)) %>%
  plotly::add_trace(y = ~ activos, 
                    name = "Activos",
                    marker = list(color = activos_color)) %>%
  plotly::add_trace(y = ~seg.term , 
                    name = "Seg. terminado",
                    marker = list(color = seg_term.color)) %>%
  plotly::add_trace(y = ~ Recuperados, 
                    name = "Recuperados",
                    marker = list(color = recuperados_color)) %>%
  plotly::add_trace(y = ~ Decesos, 
                    name = "Decesos",
                    marker = list(color = decesos_color)) %>%
  plotly::layout(
    barmode = 'stack',
    legend = list(#x = 0.01, y = .99, 
                  text.font = list(fontsize=8), bg="transparent"), 
    yaxis = list(title = "", zeroline = FALSE, 
                 showline = FALSE, showticklabels = FALSE, 
                 showgrid = FALSE, fixedrange = TRUE), 
    xaxis = list(title = "", zeroline = FALSE, 
                 showline = TRUE, showticklabels = TRUE, 
                 showgrid = FALSE, fixedrange = TRUE),
    hovermode = "compare",
    margin =  list(
    # l = 60,
    # r = 40,
    b = 10,
    t = 10,
    pad = 2
    )
  ) %>%
  plotly::config(displaylogo = FALSE,
                 modeBarButtonsToRemove = list(
                   'sendDataToCloud',
                   'zoom2d',
                   'pan2d',
                   'select2d',
                   'lasso2d',
                   'zoomIn2d', 
                   'zoomOut2d',
                   #'toImage',
                   'autoScale2d',
                   'resetScale2d',
                   'hoverClosestCartesian',
                   'hoverCompareCartesian',
                   'toggleSpikelines'
                ))

```

### **Evolución de Casos Confirmados**
    
```{r}

plotly::plot_ly(data = df_s, x = ~ Fecha) %>%
  plotly::add_trace(y = ~ Sonora,
                    type = "scatter",
                    mode = "lines",
                    name = "Sonora",
                    line = list(color = confirmados_color)) %>% #,
                    #marker = list(color = confirmados_color)) %>%
  plotly::add_trace(y = ~ Chihuahua,
                    type = "scatter",
                    mode = "lines",
                    name = "Chihuahua",
                    line = list(color = rosa_color)) %>% #,
                    #marker = list(color = rosa_color)) %>%
  plotly::add_trace(y = ~ Sinaloa,
                    type = "scatter",
                    mode = "lines",
                    name = "Sinaloa",
                    line = list(color = decesos_color)) %>% #,
                    #marker = list(color = decesos_color)) %>%
  plotly::add_trace(y = ~ `Baja California`,
                    type = "scatter",
                    mode = "lines",
                    name = "Baja California",
                    line = list(color = "darkgreen")) %>% #,
                    #marker = list(color = "darkgreen")) %>%
  plotly::add_trace(x = ~ Fecha,
                    y = ~ Nacional,
                    type = "scatter",
                    mode = "lines",
                    name = "Nacional",
                    visible = "legendonly",
                    line = list(color = recuperados_color)) %>% #,
                    #marker = list(color = recuperados_color))   %>%
  plotly::add_trace(x = ~ Fecha,
                    y = ~ Arizona,
                    type = "scatter",
                    mode = 'lines',
                    name = "Arizona",
                    visible = "legendonly",
                    line = list(color = activos_color)) %>% #,
                    #marker = list(color = activos_color))   %>%   
  plotly::layout(title = "",
                 yaxis = list(title = "Casos", fixedrange = TRUE),
                 xaxis = list(title = "", fixedrange = TRUE),
                 legend = list(x = 0.01, y = .99, text.font = list(fontsize=8)), 
                 hovermode = "compare") %>%
  plotly::config(displaylogo = FALSE,
                 modeBarButtonsToRemove = list(
                   'sendDataToCloud',
                   'zoom2d',
                   'pan2d',
                   'select2d',
                   'lasso2d',
                   'zoomIn2d', 
                   'zoomOut2d',
                   #'toImage',
                   #'autoScale2d',
                   'resetScale2d',
                   'hoverClosestCartesian',
                   'hoverCompareCartesian',
                   'toggleSpikelines'
                ))

```


Row 
-----------------------------------------------------------------------

### **Evolución acumulada por semana (última semana en proceso)**


```{r}

df.tend %>%
  mutate(
    Defunciones = Defunciones - lag(Defunciones),
    Pruebas = Pruebas - lag(Pruebas),
    Confirmados = Positivos - lag(Positivos)
  ) %>%
  filter(Fecha > max(Fecha) - 45) %>%
  group_by(semana = cut(Fecha, "week")) %>%   # lubridate::epiweek(Fecha)
  summarize(
    Decesos = sum(Defunciones, na.rm = TRUE),
    Pruebas = sum(Pruebas, na.rm = TRUE),
    Confirmados = sum(Confirmados, na.rm = TRUE)
  ) %>%
  plotly::plot_ly(
    x = ~semana, 
    y = ~ Pruebas, 
    type = "bar", 
    name = "Pruebas",
    marker = list(color = confirmados_color)) %>%
  plotly::add_trace(
    y = ~Confirmados, 
    name = "Confirmados",
    marker = list(color = activos_color)) %>%
  plotly::add_trace(
    y = ~ Decesos, 
    name = "Decesos",
    marker = list(color = decesos_color)) %>%
  plotly::layout(
    barmode = 'group',
    yaxis = list(title = "", zeroline = FALSE, showline = FALSE, 
                 showticklabels = FALSE, showgrid = FALSE, fixedrange = TRUE), 
    xaxis = list(title = "", zeroline = FALSE, showline = TRUE, 
                 showticklabels = TRUE, showgrid = FALSE, fixedrange = TRUE),
    legend = list(
      orientation = "h", xanchor = "center", 
      x = 0.5, y =-.2, text.font = list(fontsize=8)),
      # x = 0.01, y = .99, text.font = list(fontsize=8)), 
    hovermode = "compare",
    margin =  list(
      # l = 60,
      # r = 40,
      b = 10,
      t = 10,
      pad = 2
    )
  ) %>%
  plotly::config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = list(
      'sendDataToCloud', 'zoom2d', 'pan2d', 'select2d', 'lasso2d',
      'zoomIn2d', 'zoomOut2d',
      #'toImage',
      'autoScale2d', 'resetScale2d', 'hoverClosestCartesian',
      'hoverCompareCartesian', 'toggleSpikelines'
    )
  )


```   


### **Casos nuevos al `r  format(as.Date(max(df_s$Fecha)), "%d/%m/%y")`**
    
```{r}

data.frame(
  Estado = c("Sonora", "Chihuahua", "Baja California", "Sinaloa", "Nacional", "Arizona"),
  N.Confirmados = c(
    max(0, last(diff(df_s$Sonora[!is.na(df_s$Sonora)]))),
    max(0, last(diff(df_s$Chihuahua[!is.na(df_s$Chihuahua)]))),
    max(0, last(diff(df_s$`Baja California`[!is.na(df_s$`Baja California`)]))),
    max(0, last(diff(df_s$Sinaloa[!is.na(df_s$Sinaloa)]))),
    max(0, last(diff(df_s$Nacional[!is.na(df_s$Nacional)]))),
    max(0, last(diff(df_s$Arizona[!is.na(df_s$Arizona)])))
  )
) %>%
  plotly::plot_ly(
    x = ~N.Confirmados,
    y = ~reorder(Estado, N.Confirmados),
    text = ~paste(N.Confirmados, "casos nuevos", sep=" "),
    hoverinfo = 'text',
    textposition = 'auto',
    name = "C. nuevos",
    type = "bar", 
    marker = list(color = confirmados_color),
    orientation = 'h') %>%
  plotly::layout(
    yaxis = list(title = "", zeroline = FALSE, showline = TRUE, 
                 showticklabels = TRUE, showgrid = FALSE,
                 fixedrange = TRUE),
    xaxis = list(title = "", zeroline = FALSE, showline = FALSE, 
                 showticklabels = FALSE, showgrid = FALSE,
                 fixedrange = TRUE),
    margin = list( l = 10, r = 10, b = 10, t = 10, pad = 2)) %>%
  plotly::layout(
        showlegend = FALSE
  ) %>%
  plotly::config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = list(
      'sendDataToCloud','zoom2d','pan2d', 'select2d', 'lasso2d',
      'zoomIn2d', 'zoomOut2d',
      #'toImage',
      'autoScale2d', 'resetScale2d', 'hoverClosestCartesian',
      'hoverCompareCartesian', 'toggleSpikelines'))


```

Row {data-height=80}
-----------------------------------------------------------------------
<img align="right" height=70 src="logo-color.png" />   


Mapa
=======================================================================

Row {data-height=920}
-----------------------------------------------------------------------

### **Mapa con casos por Estados y Municipios en la Megaregión Sonora-Arizona**

```{r}
#-----------------Inicializa mapa----------------------
library(leaflet)
library(leafpop)

map_object <- leaflet(
  options = leafletOptions(minZoom = 5, maxZoom = 10)
) %>% 
  addTiles() %>%
  #addProviderTiles(providers$Stamen.Toner) %>%
  setView(
    lng = -110.8269,
    lat = 29.4720,
    zoom = 6
  )

pal <- colorFactor(
   c("blue", confirmados_color, decesos_color, "red"), 
   domain = c("Arizona", "Estados", "Sonora", "Negativos")
)

circulitos <- function (cosa, df, pal, pal.str, opacidad, info.popup) {
  addCircleMarkers( 
    cosa,
    data= df,
    lng= ~Long, lat= ~Lat,
    label= ~paste(pal.str, ', ', Municipio, ", casos: ", Confirmados, sep = ''),
    color = ~pal(pal.str),
    stroke = FALSE, fillOpacity = opacidad,
    radius = ~(3 + 1.5*log(Confirmados)),
    popup =  leafpop::popupTable(
      df,
      feature.id = FALSE,
      row.numbers = FALSE,
      zcol = info.popup
    ),
    labelOptions = labelOptions(
      noHide = F,
      direction = 'auto'
    )
  )
}



#-----------------Primera capa: Arizona------------------
az_map <- df_az %>%
  dplyr::group_by(Estado, Municipio, Lat, Long) %>%    
  dplyr::summarise(
    Confirmados = sum(Confirmados),
    Activos = sum(Activos),
    Decesos = sum(Decesos),
    Recuperados = sum(Recuperados)
  ) %>%
  filter(Municipio != "Unassigned")

map_object <<- map_object %>%
  circulitos(az_map, pal, "Arizona", 0.6,
             c("Municipio", "Confirmados", "Decesos"))

#-----------------Segunda Capa: Estados----------------------------

edos_con <- df.mex.conf %>% 
  filter(Fecha == max(Fecha)) %>% 
  pivot_longer(-Fecha, names_to = "Estado", values_to = "Confirmados") %>% 
  select(-Fecha) %>% 
  mutate(Estado = gsub('\\.', ' ', Estado))

edos_dec <- df.mex.dec %>% 
  filter(Fecha == max(Fecha)) %>% 
  pivot_longer(-Fecha, names_to = "Estado", values_to = "Decesos") %>% 
  select(-Fecha) %>% 
  mutate(Estado = gsub('\\.', ' ', Estado))

edos_map <-edos_con %>% 
  dplyr::left_join(edos_dec, by = "Estado") %>%
  dplyr::left_join(
    read.csv("../data/estados_latlon.csv", stringsAsFactors = FALSE),
    by = "Estado"
  ) %>%
  dplyr::filter(Estado != "Nacional") %>%
  dplyr::filter(Estado != "Sonora") %>%
  dplyr::mutate(Municipio = Estado)

map_object <<- map_object %>%
  circulitos(edos_map, pal, "Estados", 0.6, c("Estado","Confirmados", "Decesos"))


#-----------------Tercera Capa: Municipios Sonora----------------
mun_map <- df_municipios %>% dplyr::left_join(
  read.csv("../data/municipios_latlon.csv", stringsAsFactors = FALSE),
  by = "Municipio"
) %>% left_join(
  df.extracto %>% select(-Confirmados), 
  by = "Municipio"
)

map_object <<- map_object %>%
  circulitos(mun_map, pal, "Sonora", 0.99, 
             c("Municipio","Confirmados", "Decesos", "Negativos", "Pruebas en proceso"))

#-----------------Cuarta Capa: Municipios sin confirmados----------

mun_nmap <- df.extracto %>% 
  select(-Confirmados) %>% 
  dplyr::left_join(df_municipios, by = "Municipio") %>%
  filter(is.na(Confirmados)) %>%
  select(Municipio, Negativos, `Pruebas en proceso`) %>%
  dplyr::left_join(
    read.csv("../data/municipios_latlon.csv", stringsAsFactors = FALSE),
    by = "Municipio"
  ) %>%
  mutate(Confirmados = 2) %>%
  filter(!is.na(Lat))

map_object <<- map_object %>%
  addCircleMarkers(
    data= mun_nmap,
    lng= ~Long, lat= ~Lat,
    label= ~paste(Municipio, ", pruebas: ", Negativos + `Pruebas en proceso`, sep = ''),
    color = ~pal("Negativos"),
    stroke = FALSE, fillOpacity = 0.9,
    radius = ~(3 + 2*log(Confirmados)),
    popup =  leafpop::popupTable(
      mun_nmap,
      feature.id = FALSE,
      row.numbers = FALSE,
      zcol = c("Municipio", "Negativos", "Pruebas en proceso")
    ),
    labelOptions = labelOptions(
      noHide = F,
      direction = 'auto'
    )
  )

map_object

#-----------------Configuración final------------------------ 
# map_object #%>%
#  addLayersControl(
#    overlayGroups = c("Arizona", "Estados"),
#    options = layersControlOptions(collapsed = FALSE) 
#)
```

Row {data-height=80}
-----------------------------------------------------------------------
<img align="right" height=70 src="logo-color.png" />   


Estadísticas
=======================================================================


Row
-----------------------------------------------------------------------



### Genero (% Mujeres) 

```{r}

gen.per <- format( 100 * last(df_mio$Mujeres) / last(df_mio$Confirmados), digits = 3)
valueBox(
  value = gen.per, 
  caption = "% de Casos Confirmados son Mujeres", 
  icon = "fas fa-venus", 
  color = decesos_color
)

```

### Pruebas Realizadas 

```{r}
#realizadas <- nrow(df_sss)

realizados <- last(df_mio$Estudiados)
valueBox(paste(format(realizados, big.mark = ",")), icon = "fa-heartbeat", color = activos_color)
```

### Pruebas Negativas 

```{r}
negativos <- last(df_mio$Negativos)
valueBox(paste(format(negativos, big.mark = ",")), icon = "fa-check-square", color = recuperados_color)
```


### Tasa de Letalidad (%)

```{r}

letalidad <- format(100 * df_son_c$Decesos / df_son_c$Confirmados, digits = 3)
valueBox(letalidad, icon = "fa-user", color = confirmados_color)

```


<!-- ###  -->
<!-- ```{r out.width="10%"} -->
<!-- knitr::include_graphics("escudo.png") -->
<!-- ``` -->


Row  
-------------------------------------

### **Distribución por edad**
    
```{r}

edad.df <- read.csv("../data/edad.csv", stringsAsFactors = FALSE)
plotly::plot_ly(
    data = edad.df, 
    x = ~ Edad, 
    y = ~ Casos, 
    type = "bar", 
    name = "Confirmados",
    text = ~Casos,
    hoverinfo = 'text',
    textposition = 'auto',
    marker = list(color = confirmados_color)) %>%
  plotly::add_trace(
    y = ~ Decesos, 
    name = "Decesos",
    text = ~Decesos,
    hoverinfo = 'text',
    textposition = 'auto',
    marker = list(color = decesos_color)) %>%
  plotly::layout(
    barmode = 'group',                     
    legend = list(x=0.001, y = 0.999, opacity=0.1),
    yaxis = list(title = "", zeroline = FALSE, showline = FALSE, 
                 showticklabels = FALSE, showgrid = FALSE, fixedrange = TRUE), 
    xaxis = list(title = "", zeroline = FALSE, showline = TRUE, 
                 showticklabels = TRUE, showgrid = FALSE, fixedrange = TRUE),
    hovermode = "compare",
    margin =  list( 
      # l = 60, r = 40,
      b = 10, t = 10, pad = 2
    )
  ) %>%
  plotly::config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = list(
      'sendDataToCloud','zoom2d', 'pan2d', 'select2d', 'lasso2d',
      'zoomIn2d', 'zoomOut2d',
      #'toImage',
      'autoScale2d', 'resetScale2d', 'hoverClosestCartesian',
      'hoverCompareCartesian', 'toggleSpikelines'
    )
  )

```

### **Relación de comorbilidades, género y defunciones**

```{r}

df.comorb <- read.csv("../data/comorbilidades.csv", stringsAsFactors = FALSE)

temp <- group_by(df.comorb, Sexo) %>% 
  summarise(
    tot = sum(Vivos) + sum(Decesos), 
    viv = sum(Vivos), 
    dec = sum(Decesos)
  )

temp2 <- data.frame(
  ids = c(
    "Total",
    "Mujeres", "Hombres", "Mujeres - Vivas", "Mujeres - Defunciones",
    "Mujeres - Defunciones - Con comorbilidad", "Mujeres - Defunciones - Sin comorbilidad",
    "Mujeres - Vivas - Con comorbilidad", "Mujeres - Vivas - Sin comorbilidad",
    "Hombres - Vivos", "Hombres - Defunciones",
    "Hombres - Defunciones - Con comorbilidad", "Hombres - Defunciones - Sin comorbilidad",
    "Hombres - Vivos - Con comorbilidad", "Hombres - Vivos - Sin comorbilidad"
  ),
  labels = c(
    "Total",
    "Mujeres", "Hombres", "Vivas", "Defunciones",
    "Con comorbilidad", "Sin comorbilidad",
    "Con comorbilidad", "Sin comorbilidad",
    "Vivos", "Defunciones",
    "Con comorbilidad", "Sin comorbilidad",
    "Con comorbilidad", "Sin comorbilidad"
  ),
  parents = c(
    "", "Total", "Total", "Mujeres", "Mujeres",
    "Mujeres - Defunciones", "Mujeres - Defunciones",
    "Mujeres - Vivas", "Mujeres - Vivas",
    "Hombres", "Hombres",
    "Hombres - Defunciones", "Hombres - Defunciones",
    "Hombres - Vivos", "Hombres - Vivos"
  ),
  values = c(
    sum(temp$tot),
    temp$tot[temp$Sexo == "Mujeres"], 
    temp$tot[temp$Sexo == "Hombres"],
    temp$viv[temp$Sexo == "Mujeres"], 
    temp$dec[temp$Sexo == "Mujeres"],
    df.comorb$Decesos[df.comorb$Sexo == "Mujeres" & df.comorb$Comorbilidad == "Con comorbilidad"],
    df.comorb$Decesos[df.comorb$Sexo == "Mujeres" & df.comorb$Comorbilidad == "Sin comorbilidad"],
    df.comorb$Vivos[df.comorb$Sexo == "Mujeres" & df.comorb$Comorbilidad == "Con comorbilidad"],
    df.comorb$Vivos[df.comorb$Sexo == "Mujeres" & df.comorb$Comorbilidad == "Sin comorbilidad"],
    temp$viv[temp$Sexo == "Hombres"], 
    temp$dec[temp$Sexo == "Hombres"],
    df.comorb$Decesos[df.comorb$Sexo == "Hombres" & df.comorb$Comorbilidad == "Con comorbilidad"],
    df.comorb$Decesos[df.comorb$Sexo == "Hombres" & df.comorb$Comorbilidad == "Sin comorbilidad"],
    df.comorb$Vivos[df.comorb$Sexo == "Hombres" & df.comorb$Comorbilidad == "Con comorbilidad"],
    df.comorb$Vivos[df.comorb$Sexo == "Hombres" & df.comorb$Comorbilidad == "Sin comorbilidad"]
  ),
    stringsAsFactors = FALSE
) 
  
plotly::plot_ly(
    data = temp2,
    ids = ~ids, 
    labels = ~labels, 
    parents = ~parents, 
    values = ~values,
    type = 'sunburst',
    branchvalues = 'total'
  ) %>%
  plotly::layout(
      sunburstcolorway = c(
        "#636efa","#EF553B","#00cc96","#ab63fa","#19d3f3",
        "#e763fa", "#FECB52","#FFA15A","#FF6692","#B6E880"
      ),
      extendsunburstcolors = TRUE
  )

```

 
   
Row
-------------------------------------
   

### **Por Servicio Médico**

```{r}

pie.colores <- c(activos_color, decesos_color, recuperados_color, confirmados_color,
                 'light-blue', 'pale-yellow', 'teal', 'pink', 'indigo', 'orange', 'cyan')

read.csv("../data/servicio_medico.csv", stringsAsFactors = FALSE) %>%
    plotly::plot_ly(
    labels = ~Servicio.Medico,
    values = ~Casos,
    type = "pie",
    textposition = 'inside',
    textinfo = 'label+percent',
    hoverinfo = 'text',
    text = ~paste(Casos, ifelse(Casos == 1, ' caso', ' casos')),
    marker = list(colors = pie.colores)
  ) %>%
  plotly::layout(title = ' ',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, 
                      showticklabels = FALSE, fixedrange = TRUE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, 
                      showticklabels = FALSE, fixedrange = TRUE)
  )%>%
  plotly::config(displaylogo = FALSE,
                 modeBarButtonsToRemove = list(
                   'sendDataToCloud',
                   'zoom2d',
                   'pan2d',
                   'select2d',
                   'lasso2d',
                   'zoomIn2d', 
                   'zoomOut2d',
                   #'toImage',
                   'autoScale2d',
                   'resetScale2d',
                   'hoverClosestCartesian',
                   'hoverCompareCartesian',
                   'toggleSpikelines'
                ))


```
    


### **Hospitalizados respecto a casos activos**

```{r}
hosp <- last(df_mio$Hospitalizados)
graves <- last(df_mio$Graves)
venti <- last(df_mio$Ventilacion)
confirmados <- df_son_c$Confirmados
decesos <- df_son_c$Decesos
recuperados <- df_son_c$Recuperados
seg.term <- last(df_mio$Seguimiento.terminado)
activos <- confirmados - recuperados - decesos - seg.term


plotly::plot_ly(
    domain = list(x = c(0, 1), y = c(0, 1)),
    value = hosp,
    title = list(text = ""),
    type = "indicator",
    mode = "gauge+number",
    gauge = list(
      axis = list(range = list(NULL, activos)),
      bar = list(color = "red"),
      steps = list( list(range = c(0, graves), color = "darkred"))
    )
  ) %>%
  plotly::layout(margin = list(l=20,r=30)) %>%
  plotly::config(displaylogo = FALSE) %>%
  plotly::add_annotations(
    text = paste(graves, "graves", sep = " "),
    font = list(color="darkred"),
    showarrow  = FALSE,
    xref = "paper", yref="paper",
    x= 0.5, y = -0.01
  )


```



Row {data-height=80}
-----------------------------------------------------------------------
<img align="right" height=70 src="logo-color.png" />   


Municipios
=======================================================================


Row
-----------------------------------------------------------------------


### **Casos nuevos por semana (última semana en proceso)**

```{r}
df.evol %>%
  filter(Fecha > max(Fecha) - 45) %>%
  group_by(semana = lubridate::isoweek(Fecha)) %>% 
  summarize(
    Hermosillo = sum(Hillo.confirmados, na.rm = TRUE),
    Cajeme = sum(Cajeme.confirmados, na.rm = TRUE),
    SLRC = sum(SLRC.confirmados, na.rm = TRUE),
    Nogales = sum(Nogales.confirmados, na.rm = TRUE),
    Caborca = sum(Caborca.confirmados, na.rm = TRUE),
    AP = sum(AP.confirmados, na.rm = TRUE),
    Navojoa = sum(Navojoa.confirmados, na.rm = TRUE),
    Guaymas = sum(Guaymas.confirmados, na.rm = TRUE),
) %>%
  plotly::plot_ly(
    x = ~semana, 
    y = ~ Hermosillo, 
    type = "bar", 
    opacity = 0.8,
    name = "Hermosillo") %>%
  plotly::add_trace(y = ~Cajeme, name = "Cajeme") %>%
  plotly::add_trace(y = ~Nogales, name = "Nogales") %>%
  plotly::add_trace(y = ~SLRC, name = "SLRC") %>%
  plotly::add_trace(y = ~Navojoa, name = "Navojoa") %>%
  plotly::add_trace(y = ~Guaymas, name = "Guaymas") %>%
  plotly::add_trace(y = ~Caborca, name = "Caborca") %>%
  plotly::add_trace(y = ~AP, name = "Agua Prieta") %>%
  plotly::layout(
    barmode = 'stack',
    opacity = 0.8,
    yaxis = list(title = "", zeroline = FALSE, showline = FALSE, 
                 showticklabels = TRUE, showgrid = FALSE, fixedrange = TRUE), 
    xaxis = list(title = "semana epidemiológica", zeroline = FALSE, showline = TRUE, 
                 showticklabels = TRUE, showgrid = FALSE, fixedrange = TRUE),
    #legend = list(x = 0.01, y = .99, text.font = list(fontsize=8)), 
    hovermode = "compare",
    margin =  list(
      # l = 60,
      # r = 40,
      b = 10,
      t = 10,
      pad = 2
    )
  ) %>%
  plotly::config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = list(
      'sendDataToCloud', 'zoom2d', 'pan2d', 'select2d', 'lasso2d',
      'zoomIn2d', 'zoomOut2d',
      #'toImage',
      'autoScale2d', 'resetScale2d', 'hoverClosestCartesian',
      'hoverCompareCartesian', 'toggleSpikelines'
    )
  )

```




### **Decesos por semana (última semana en proceso)**

```{r}

df.evol %>%
  filter(Fecha > max(Fecha) - 45) %>%
  group_by(semana = lubridate::isoweek(Fecha)) %>% 
  summarize(
    Hermosillo = sum(Hillo.decesos, na.rm = TRUE),
    Cajeme = sum(Cajeme.decesos, na.rm = TRUE),
    SLRC = sum(SLRC.decesos, na.rm = TRUE),
    Nogales = sum(Nogales.decesos, na.rm = TRUE),
    Caborca = sum(Caborca.decesos, na.rm = TRUE),
    AP = sum(AP.decesos, na.rm = TRUE),
    Navojoa = sum(Navojoa.decesos, na.rm = TRUE),
    Guaymas = sum(Guaymas.decesos, na.rm = TRUE),
) %>%
  plotly::plot_ly(
    x = ~semana, 
    y = ~ Hermosillo, 
    type = "bar", 
    opacity = 0.8,
    name = "Hermosillo") %>%
  plotly::add_trace(y = ~Cajeme, name = "Cajeme") %>%
  plotly::add_trace(y = ~Nogales, name = "Nogales") %>%
  plotly::add_trace(y = ~SLRC, name = "SLRC") %>%
  plotly::add_trace(y = ~Navojoa, name = "Navojoa") %>%
  plotly::add_trace(y = ~Guaymas, name = "Guaymas") %>%
  plotly::add_trace(y = ~Caborca, name = "Caborca") %>%
  plotly::add_trace(y = ~AP, name = "Agua Prieta") %>%
  plotly::layout(
    barmode = 'stack',
    opacity = 0.8,
    yaxis = list(title = "", zeroline = FALSE, showline = FALSE, 
                 showticklabels = TRUE, showgrid = FALSE, fixedrange = TRUE), 
    xaxis = list(title = "semana epidemiológica", zeroline = FALSE, showline = TRUE, 
                 showticklabels = TRUE, showgrid = FALSE, fixedrange = TRUE),
    #legend = list(x = 0.01, y = .99, text.font = list(fontsize=8)), 
    hovermode = "compare",
    margin =  list(
      # l = 60,
      # r = 40,
      b = 10,
      t = 10,
      pad = 2
    )
  ) %>%
  plotly::config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = list(
      'sendDataToCloud', 'zoom2d', 'pan2d', 'select2d', 'lasso2d',
      'zoomIn2d', 'zoomOut2d',
      #'toImage',
      'autoScale2d', 'resetScale2d', 'hoverClosestCartesian',
      'hoverCompareCartesian', 'toggleSpikelines'
    )
  )

```


Row
-----------------------------------------------------------------------


### **Casos nuevos últimos 7 días en los 8 municipios con mayor población**

```{r}

df.evol %>%
  mutate(
    Hermosillo = Hillo.confirmados,
    Cajeme = Cajeme.confirmados,
    SLRC = SLRC.confirmados,
    Nogales = Nogales.confirmados,
    Caborca = Caborca.confirmados,
    AP = AP.confirmados,
    Navojoa = Navojoa.confirmados,
    Guaymas = Guaymas.confirmados,
  ) %>%
  filter(Fecha > max(Fecha) - 7) %>%
  plotly::plot_ly(
    x = ~Fecha, 
    y = ~ Hermosillo, 
    type = "bar", 
    opacity = 0.8,
    name = "Hermosillo") %>%
  plotly::add_trace(y = ~Cajeme, name = "Cajeme") %>%
  plotly::add_trace(y = ~Nogales, name = "Nogales") %>%
  plotly::add_trace(y = ~SLRC, name = "SLRC") %>%
  plotly::add_trace(y = ~Navojoa, name = "Navojoa") %>%
  plotly::add_trace(y = ~Guaymas, name = "Guaymas") %>%
  plotly::add_trace(y = ~Caborca, name = "Caborca") %>%
  plotly::add_trace(y = ~AP, name = "Agua Prieta") %>%
  plotly::layout(
    barmode = 'stack',
    opacity = 0.8,
    yaxis = list(title = "", zeroline = FALSE, showline = FALSE, 
                 showticklabels = TRUE, showgrid = FALSE, fixedrange = TRUE), 
    xaxis = list(title = "", zeroline = FALSE, showline = TRUE, 
                 showticklabels = TRUE, showgrid = FALSE, fixedrange = TRUE),
    #legend = list(x = 0.01, y = .99, text.font = list(fontsize=8)), 
    hovermode = "compare",
    margin =  list(
      # l = 60,
      # r = 40,
      b = 10,
      t = 10,
      pad = 2
    )
  ) %>%
  plotly::config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = list(
      'sendDataToCloud', 'zoom2d', 'pan2d', 'select2d', 'lasso2d',
      'zoomIn2d', 'zoomOut2d',
      #'toImage',
      'autoScale2d', 'resetScale2d', 'hoverClosestCartesian',
      'hoverCompareCartesian', 'toggleSpikelines'
    )
  )

```



### **Casos confirmados por municipio**

```{r}

mun <- df_municipios$Municipio 
conf.mun <- df_municipios$Confirmados 
mun <- mun[order(conf.mun, decreasing = TRUE)]
conf.mun <- conf.mun[order(conf.mun, decreasing = TRUE)]
mun <- c(mun[1:8], "Resto", mun[9:length(mun)])
conf.mun <- c(conf.mun[1:8], 0, conf.mun[9:length(conf.mun)])

plotly::plot_ly(
  type='treemap',
  labels= mun,
  values= conf.mun,
  parents = c(rep(' ', 9), rep('Resto', length(df_municipios$Confirmados) - 8)),
  textinfo="label+value+percent parent"
) %>%
  plotly::config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = list(
      'sendDataToCloud',
      'zoom2d',
      'pan2d',
      'select2d',
      'lasso2d',
      'zoomIn2d', 
      'zoomOut2d',
      #'toImage',
      'autoScale2d',
      'resetScale2d',
      'hoverClosestCartesian',
      'hoverCompareCartesian',
      'toggleSpikelines'
    )
  )

```


   

Row {data-height=80}
-----------------------------------------------------------------------
<img align="right" height=70 src="logo-color.png" />   



Evolución
========================================================================

Row 
-----------------------------------------------------------------------

### **Municipios con mayor incremento de casos (últimos 7 días)**

```{r}
dt.incrementos <- left_join(
  df.mun.con %>% 
    filter(Fecha == hoy) %>% 
    select(-Fecha) %>%
    pivot_longer(everything(),  names_to = "Municipio", values_to = "hoy"),
  df.mun.con %>% 
    filter(Fecha == hoy - 7) %>% 
    select(-Fecha) %>%
    pivot_longer(everything(),  names_to = "Municipio", values_to = "siete.dias"),
  by = "Municipio"
) %>%
filter(Municipio != "Estado") %>%
mutate(incrementos = hoy - siete.dias) 

dt.incrementos %>%
  slice_max(incrementos, n = 5) %>%
  plotly::plot_ly(
    x = ~incrementos,
    y = ~reorder(Municipio, incrementos),
    text = ~paste(incrementos, "casos nuevos en 7 días"),
    hoverinfo = 'text',
    textposition = 'auto',
    name = "incrementos",
    type = "bar", 
    marker = list(color = confirmados_color),
    orientation = 'h') %>%
  plotly::layout(
    yaxis = list(title = "", zeroline = FALSE, showline = TRUE, 
                 showticklabels = TRUE, showgrid = FALSE,
                 fixedrange = TRUE),
    xaxis = list(title = "", zeroline = FALSE, showline = FALSE, 
                 showticklabels = FALSE, showgrid = FALSE,
                 fixedrange = TRUE),
    margin = list( l = 10, r = 10, b = 10, t = 10, pad = 2)) %>%
  plotly::layout(
        showlegend = FALSE
  ) %>%
  plotly::config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = list(
      'sendDataToCloud','zoom2d','pan2d', 'select2d', 'lasso2d',
      'zoomIn2d', 'zoomOut2d',
      #'toImage',
      'autoScale2d', 'resetScale2d', 'hoverClosestCartesian',
      'hoverCompareCartesian', 'toggleSpikelines'))


```

### **Municipios con mayor incremento de casos en porcentaje (últimos 7 días)**

```{r}
dt.incrementos %>%
  mutate(porcentaje = 100 * incrementos / hoy) %>%
  slice_max(porcentaje, n = 5) %>%
  plotly::plot_ly(
    x = ~porcentaje,
    y = ~reorder(Municipio, porcentaje),
    text = ~paste(format(porcentaje, digits = 3), 
                  "% del total de casos acumulados", sep=""),
    hoverinfo = 'text',
    textposition = 'auto',
    name = "incrementos",
    type = "bar", 
    marker = list(color = decesos_color),
    orientation = 'h') %>%
  plotly::layout(
    yaxis = list(title = "", zeroline = FALSE, showline = TRUE, 
                 showticklabels = TRUE, showgrid = FALSE,
                 fixedrange = TRUE),
    xaxis = list(title = "", zeroline = FALSE, showline = FALSE, 
                 showticklabels = FALSE, showgrid = FALSE,
                 fixedrange = TRUE),
    margin = list( l = 10, r = 10, b = 10, t = 10, pad = 2)) %>%
  plotly::layout(
        showlegend = FALSE
  ) %>%
  plotly::config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = list(
      'sendDataToCloud','zoom2d','pan2d', 'select2d', 'lasso2d',
      'zoomIn2d', 'zoomOut2d',
      #'toImage',
      'autoScale2d', 'resetScale2d', 'hoverClosestCartesian',
      'hoverCompareCartesian', 'toggleSpikelines'))


```

Row 
-----------------------------------------------------------------------

### **Municipios con mayor incremento de decesos (últimos 7 días)**

```{r}
dt.incrementos.dec <- left_join(
  df.mun.dec %>% 
    filter(Fecha == hoy) %>% 
    select(-Fecha) %>%
    pivot_longer(everything(),  names_to = "Municipio", values_to = "hoy"),
  df.mun.dec %>% 
    filter(Fecha == hoy - 7) %>% 
    select(-Fecha) %>%
    pivot_longer(everything(),  names_to = "Municipio", values_to = "siete.dias"),
  by = "Municipio"
) %>%
  mutate(incrementos = hoy - siete.dias) %>%
  filter(Municipio != "Estado")
  
  
dt.incrementos.dec %>%  
  slice_max(incrementos, n = 5) %>% 
  plotly::plot_ly(
    x = ~incrementos,
    y = ~reorder(Municipio, incrementos),
    text = ~paste(incrementos, "decesos en los últimos 7 días"),
    hoverinfo = 'text',
    textposition = 'auto',
    name = "incrementos",
    type = "bar", 
    marker = list(color = confirmados_color),
    orientation = 'h') %>%
  plotly::layout(
    yaxis = list(title = "", zeroline = FALSE, showline = TRUE, 
                 showticklabels = TRUE, showgrid = FALSE,
                 fixedrange = TRUE),
    xaxis = list(title = "", zeroline = FALSE, showline = FALSE, 
                 showticklabels = FALSE, showgrid = FALSE,
                 fixedrange = TRUE),
    margin = list( l = 10, r = 10, b = 10, t = 10, pad = 2)) %>%
  plotly::layout(
        showlegend = FALSE
  ) %>%
  plotly::config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = list(
      'sendDataToCloud','zoom2d','pan2d', 'select2d', 'lasso2d',
      'zoomIn2d', 'zoomOut2d',
      #'toImage',
      'autoScale2d', 'resetScale2d', 'hoverClosestCartesian',
      'hoverCompareCartesian', 'toggleSpikelines'))


```

### **Municipios con mayor incremento de decesos en porcentaje (últimos 7 días)**

```{r}
dt.incrementos.dec %>%
  mutate(porcentaje = 100 * incrementos / hoy) %>%
  slice_max(porcentaje, n = 5) %>% 
  plotly::plot_ly(
    x = ~porcentaje,
    y = ~reorder(Municipio, porcentaje),
    text = ~paste(format(porcentaje, digits = 3), 
                  "% del total de decesos acumulados", sep=""),
    hoverinfo = 'text',
    textposition = 'auto',
    name = "incrementos",
    type = "bar", 
    marker = list(color = decesos_color),
    orientation = 'h') %>%
  plotly::layout(
    yaxis = list(title = "", zeroline = FALSE, showline = TRUE, 
                 showticklabels = TRUE, showgrid = FALSE,
                 fixedrange = TRUE),
    xaxis = list(title = "", zeroline = FALSE, showline = FALSE, 
                 showticklabels = FALSE, showgrid = FALSE,
                 fixedrange = TRUE),
    margin = list( l = 10, r = 10, b = 10, t = 10, pad = 2)) %>%
  plotly::layout(
        showlegend = FALSE
  ) %>%
  plotly::config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = list(
      'sendDataToCloud','zoom2d','pan2d', 'select2d', 'lasso2d',
      'zoomIn2d', 'zoomOut2d',
      #'toImage',
      'autoScale2d', 'resetScale2d', 'hoverClosestCartesian',
      'hoverCompareCartesian', 'toggleSpikelines'))


```


Row {data-height=80}
-----------------------------------------------------------------------
<img align="right" height=70 src="logo-color.png" />


Camas
=======================================================================

Row
-------------------------------------------------------------------------

### **Evolución de la ocupación hospitalaria en Sonora**

```{r evo.general}

df.hospitalizados <- read.csv("../Datos-Covid19/REPORTE-HOSPITALARIO/acumulados.csv")

op <- 0.4
df.hospitalizados %>% 
mutate(fecha = as.Date(fecha)) %>%
filter(fecha >= as.Date("2020-06-02", "%Y-%m-%d")) %>%
plotly::plot_ly(x = ~fecha) %>%
  plotly::add_ribbons(
    ymax = ~Sonora_disponibles, ymin = ~(0.65 * Sonora_disponibles), opacity = op,
    line = list(color = 'red'), fillcolor = 'red',
    hoverinfo = 'text+x', text = ~paste(Sonora_disponibles, "camas disponibles"),
    name = "Camas disponibles"
  ) %>%
  plotly::add_ribbons(
    ymax = ~(0.65*Sonora_disponibles), ymin = ~(0.52 * Sonora_disponibles), opacity = op,
    line = list(color = 'orange'), fillcolor = 'orange',
    name = "65% ocupación",
    hoverinfo = 'text', text = ~paste("65% ocupación"),
  ) %>%
  plotly::add_ribbons(
    ymax = ~(0.52*Sonora_disponibles), ymin = ~(0.40 * Sonora_disponibles), opacity = op,
    line = list(color = 'yellow'), fillcolor = 'yellow',
    name = "52% ocupación",
    hoverinfo = 'text', text = ~paste("52% ocupación"),
  ) %>%
  plotly::add_ribbons(
    ymax = ~(0.40*Sonora_disponibles), ymin = ~(0.0 * Sonora_disponibles), opacity = op,
    line = list(color = 'green'), fillcolor = 'green',
    name = "40% ocupación",
    hoverinfo = 'text', text = ~paste("40% ocupación"),
  ) %>%
  plotly::add_trace(
    y = ~Sonora_ocupados,
    type = "bar",
    name = "Camas ocupadas",
    marker = list(color = "darkblue"),
    text = ~ paste(Sonora_ocupados, "camas ocupadas"),
    hoverinfo = 'text'
  ) %>%
  plotly::layout(showlegend = TRUE, hovermode = "compare", title = "Camas ocupadas y disponibles en Sonora", 
                 yaxis = list(title = "camas"), xaxis = list(title = "fecha")) %>%
  plotly::layout(showlegend = TRUE, hovermode = "compare") %>%
  plotly::config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = list(
      'sendDataToCloud',
      'zoom2d',
      'pan2d',
      'select2d',
      'lasso2d',
      'zoomIn2d',
      'zoomOut2d',
      #'toImage',
      'autoScale2d',
      'resetScale2d',
      'hoverClosestCartesian',
      #'hoverCompareCartesian',
      'toggleSpikelines'
    )
  )


```

Row {data-height=80}
-----------------------------------------------------------------------
<img align="right" height=70 src="logo-color.png" />


Tendencias
=======================================================================


Row
-----------------------------------------------------------------------


### **Casos nuevos confirmados en Sonora**

```{r}


df.son %>%
  filter(Fecha >= inicio.tendencias) %>%
  mutate(nuevos = Sonora - lag(Sonora)) %>%
  mutate(nuevos.ma7 = ma(nuevos, 7)) %>%
  plotly::plot_ly(x = ~Fecha) %>%
  plotly::add_trace(
    y = ~nuevos, 
    type = 'bar', 
    name = 'Incremento confirmados',
    marker = list(color = '#C9EFF9'),
    hoverinfo = "text",
    text = ~paste(nuevos, ' casos nuevos\n', Fecha, sep = "")
    ) %>%
  plotly::add_trace(
    y = ~nuevos.ma7, 
    type = 'scatter', 
    mode = 'lines', 
    name = 'Promedio movil a 7 días',
    visible = "legendonly",
    line = list(color = '#45171D')
  )%>%
  plotly::layout(
    barmode = 'group',                     
    legend = list(x=0.01, y = 0.99, opacity=0.1),
    yaxis = list(title = "Casos", fixedrange = TRUE), 
    xaxis = list(title = "", fixedrange = TRUE),
    hovermode = "compare",
    margin =  list(
                   # l = 60,
                   # r = 40,
                   b = 10,
                   t = 10,
                   pad = 2
    )
  ) %>%
  plotly::config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = list(
      'sendDataToCloud', 'zoom2d', 'pan2d', 'select2d','lasso2d',
      'zoomIn2d', 'zoomOut2d',
      #'toImage',
      'autoScale2d', 'resetScale2d', 'hoverClosestCartesian',
      'hoverCompareCartesian', 'toggleSpikelines'
    )
  )

```



### **Evolución del porcentaje de positividad en el Estado**

```{r}

read.csv("../data/positividadLESP.csv") %>%
  mutate(Fecha = as.Date(Fecha, format = "%d/%m/%y" )) %>%
  filter(Fecha >= inicio.tendencias) %>%
  left_join(df.tend, by = "Fecha") %>%
  plotly::plot_ly(x = ~Fecha) %>%
  plotly::add_trace(
    y = ~Positividad, 
    type = 'scatter', 
    mode = 'lines+markers', 
    name = 'Positividad acumulada global',
    marker = list(color = activos_color),
    hoverinfo = "text",
    text = ~paste(Positividad, '%')
  ) %>%
  plotly::add_trace(
    y = ~Positividad.LESP, 
    type = 'scatter', 
    mode = 'lines+markers', 
    name = 'Positividad LESP',
    marker = list(color = confirmados_color),
    hoverinfo = "text",
    text = ~paste(Positividad.LESP, '%')
  ) %>%
  plotly::layout(
    legend = list(x=0.01, y = 0.99, opacity=0.1),
    yaxis = list(title = "Positividad ( % )", fixedrange = TRUE), 
    xaxis = list(title = "", fixedrange = TRUE),
    hovermode = "compare",
    margin =  list(
                   # l = 60,
                   # r = 40,
                   b = 10,
                   t = 10,
                   pad = 2
    )
  ) %>%
  plotly::config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = list(
      'sendDataToCloud', 'zoom2d', 'pan2d', 'select2d','lasso2d',
      'zoomIn2d', 'zoomOut2d',
      #'toImage',
      'autoScale2d', 'resetScale2d', 'hoverClosestCartesian',
      'hoverCompareCartesian', 'toggleSpikelines'
    )
  )

```





Row
-----------------------------------------------------------------------

### **Defunciones diarias por fecha de publicación en Sonora**

```{r}

df.tend %>%
  mutate(Def_diarias = Defunciones - lag(Defunciones)) %>%
  mutate(nuevos.ma7 = ma(Def_diarias, 7)) %>%
  filter(Fecha >= inicio.tendencias) %>%
  plotly::plot_ly(x = ~Fecha) %>%
  plotly::add_trace(
    y = ~Def_diarias, 
    type = 'bar', 
    #mode = 'lines+markers', 
    name = 'Defunciones diarias',
    marker = list(color = decesos_color),
    hoverinfo = "text",
    text = ~paste(Def_diarias, 'decesos')
  ) %>%
    plotly::add_trace(
    y = ~nuevos.ma7, 
    type = 'scatter', 
    mode = 'lines', 
    name = 'Promedio movil a 7 días',
    visible = "legendonly",
    line = list(color = '#45171D')
  )%>%
  plotly::layout(
    legend = list(x=0.01, y = 0.99, opacity=0.1),
    yaxis = list(title = "Casos", fixedrange = TRUE), 
    xaxis = list(title = "", fixedrange = TRUE),
    hovermode = "compare",
    margin =  list(
                   # l = 60,
                   # r = 40,
                   b = 10,
                   t = 10,
                   pad = 2
  )) %>%
  plotly::config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = list(
      'sendDataToCloud', 'zoom2d', 'pan2d', 'select2d','lasso2d',
      'zoomIn2d', 'zoomOut2d',
      #'toImage',
      'autoScale2d', 'resetScale2d', 
      'hoverClosestCartesian', 'hoverCompareCartesian', 
      'toggleSpikelines'
    )
  )

```


### **Letalidad acumulada en Sonora por fecha de publicación**

```{r}

df.tend %>%
  filter(Fecha >= inicio.tendencias) %>%
  plotly::plot_ly(x = ~Fecha) %>%
  plotly::add_trace(
    y = ~Letalidad, 
    type = 'scatter', 
    mode = 'lines+markers', 
    name = 'Porcentaje de Letalidad',
    marker = list(color = confirmados_color),
    hoverinfo = "text",
    text = ~paste(Letalidad, '%')
  ) %>%
  plotly::layout(
    yaxis = list(title = "Letalidad ( % )", fixedrange = TRUE), 
    xaxis = list(title = "", fixedrange = TRUE),
    hovermode = "compare",
    margin =  list(
                   # l = 60,
                   # r = 40,
                   b = 10,
                   t = 10,
                   pad = 2
    )
  ) %>%
  plotly::config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = list(
      'sendDataToCloud', 'zoom2d', 'pan2d', 'select2d','lasso2d',
      'zoomIn2d', 'zoomOut2d',
      #'toImage',
      'autoScale2d', 'resetScale2d', 'hoverClosestCartesian',
      'hoverCompareCartesian', 'toggleSpikelines'
    )
  )


# dia <- inicio.hospitaizados
# fecha <- c()
# Hospitalizados <- c()
# Graves <- c()
# 
# while( dia <= hoy){
#   tmp <- read.csv(paste("../data/acc/acumulado-", format(dia, "%d-%m-%Y"), ".csv", sep=''))
#   fecha <- append(fecha, dia)
#   Hospitalizados <- append( Hospitalizados, last(tmp$Hospitalizados))
#   Graves <- append( Graves, last(tmp$Graves))
#   dia <- dia + 1
# }
# 
# df.hosp <- data.frame(
#   Fecha = fecha,
#   Hospitalizados = Hospitalizados,
#   Graves = Graves
# )
# 
# plotly::plot_ly(
#   data = df.hosp, 
#   x = ~Fecha, 
#   y = ~Graves, 
#   type = "bar", 
#   name = "Graves",
#   marker = list(color = decesos_color),
#   text = ~paste(Graves, "casos graves"),
#   hoverinfo = 'text'
# ) %>%
#   plotly::add_trace(
#     y = ~ (Hospitalizados - Graves), 
#     name = "Hospitalizados",
#     marker = list(color = confirmados_color),
#     text = ~paste(Hospitalizados, "hospitalizados"),
#     hoverinfo = 'text'
#   ) %>%
#   plotly::layout(
#     barmode = 'stack',
#     legend = list(x=0.04, y = 0.99, opacity=0.1),
#     yaxis = list(title = "Casos", fixedrange = TRUE), 
#     xaxis = list(title = "", fixedrange = TRUE),
#     hovermode = "compare",
#     margin =  list(
#       # l = 60,
#       # r = 40,
#       b = 10,
#       t = 10,
#       pad = 2
#     )
#   ) %>%
#   plotly::config(
#     displaylogo = FALSE,
#     modeBarButtonsToRemove = list(
#       'sendDataToCloud', 'zoom2d', 'pan2d', 'select2d','lasso2d',
#       'zoomIn2d', 'zoomOut2d',
#       #'toImage',
#       'autoScale2d', 'resetScale2d', 'hoverClosestCartesian',
#       'hoverCompareCartesian', 'toggleSpikelines'
#     )
#   )



```




Row {data-height=80}
-----------------------------------------------------------------------
<img align="right" height=70 src="logo-color.png" />   




Acerca de
=======================================================================

**Dashboard Unison COVID-19 Sonora**

Este tablero es un recurso elaborado por un grupo de profesores del [Departamento de Matemáticas](https://www.mat.uson.mx) de la [Universidad de Sonora](https://www.unison.mx) del área de [Ciencia de Datos](https://mcd.unison.mx). El tablero se realizó en el lenguje *R* usando el lenguaje de marcado *Rmarkdown* y la plantilla [*flexdashboard for R*](https://rmarkdown.rstudio.com/flexdashboard/index.html). Nos basamos en un ejemplo base desarrollado por [Rami Krispin](https://twitter.com/Rami_Krispin) y el cual se puede consultar [aquí](https://github.com/RamiKrispin/coronavirus_dashboard).

**Datos**

Los datos sobre el proceso del COVID-19 en el Estado de Sonora se reciben diariamente de la [Secretaría de Salud del Estado de Sonora](https://www.sonora.gob.mx/temas-de-interes/salud.html) (SSA Sonora). Particularmente la información sobre camas ocupadas proviene del Informe Hospitalario Diario COVID19 de la SSA Sonora.
Los datos sobre el proceso del COVID-19 de los estados de México se tomaron del [repositorio de datos mantenido por Gabriel Alfonso Carranco-Sapiéns](https://github.com/carranco-sga/Mexico-COVID-19). Esta base se actualiza cada día a partir de la información de la [SSA](https://www.gob.mx/salud). Los datos sobre la población de México se tomaron de [INEGI](https://www.inegi.org.mx/app/tabulados/interactivos/?px=Poblacion_07&bd=Poblacion).
Los datos sobre el proceso del COVID-19 en el estado Arizona (EU) se tomaron del [Centro de recursos sobre Coronavirus](https://coronavirus.jhu.edu) de la Universidad Johns Hopkins University & Medicine. Esta base de datos se actualiza cada día y se puede obtener [aquí](https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data). 

**Definición de variables y términos**

- *Confirmados*: cantidad de pruebas que resultaron positivas a SARS-CoV2

- *Recuperados*: cantidad de pacientes confirmados dados de alta

- *Decesos*: cantidad de pacientes fallecidos en casos confirmados

- *Mediana de edad*: mediana estadística del rango de edades de casos confirmados

- *Pruebas realizadas*: cantidad de casos confirmados más cantidad de pruebas negativas

- *Pruebas negativas*: cantidad pruebas que dieron negativo a SARS-CoV-2

- *Pruebas en proceso*: cantidad pruebas que se encuentran en proceso a la espectativa del resultado.

- *Incidencia*: Confirmados por cada 100 mil habitantes.

- *Activos*: Pacientes que tienen una segunda muestra positiva o comenzaron síntomas hace 14 días o menos y pacientes hospitalizados

- *Seguimiento terminado*:  Pacientes que han pasado más de 14 días desde el inicio de síntomas con un cuadro leve con manejo en casa.

**Indicadores**

Los indicadores son calculados a partir de las siguientes fórmulas:


$Tasa\ de\ Letalidad =  \frac{\mbox{Decesos}}{\mbox{Confirmados}} 100$

$Tasa\ de\ Positividad =  \frac{\mbox{Confirmados}}{\mbox{Pruebas realizadas}} 100$

$Positividad\ Lesp = \frac{\mbox{Pruebas positivas del día}}{\mbox{Pruebas analizadas LESP del día}} 100$

LESP:  Laboratorio Estatal de Salud Pública


---------

Las cantidades corresponden a las mediciones hechas a partir del día 2 de marzo de 2020 al último día indicado en la curva de evolución de casos confirmados de Sonora. 

**Paquetes utilizados y documentación**

* Tablero: [flexdashboard](https://rmarkdown.rstudio.com/flexdashboard/)
* Gráficas: [plotly](https://plot.ly/r/)
* Mapa: [leaflet](https://rstudio.github.io/leaflet/)
* Manipulación de datos:  [dplyr](https://dplyr.tidyverse.org/) [tidyr](https://tidyr.tidyverse.org/)
* Tablas: [DT](https://rstudio.github.io/DT/)

**Reproducibilidad**

El tablero se genera diariamente como una página web estática. Es posible realizar un *fork* al [proyecto en Github](https://github.com/mcd-unison/unison-covid-19), descargarlo, modificarlo y publicar un tablero similar en las páginas web que desees.

**Contacto**
[O. Gutú](mailto:olivia.gutu@unison.mx) | [J. P.  Soto](mailto:juanpablo.soto@unison.mx) | [J. Waissman](mailto:julio.waissman@unison.mx) | [C. Minjárez](mailto:carlos.minjarez@unison.mx)

**Licencia MIT**

Copyright (c) 2020 Universidad de Sonora

Por la presente se concede permiso, libre de cargos, a cualquier persona que obtenga una copia de este software y de los archivos de documentación asociados (el "Software"), a utilizar el Software sin restricción, incluyendo sin limitación los derechos a usar, copiar, modificar, fusionar, publicar, distribuir, sublicenciar, y/o vender copias del Software, y a permitir a las personas a las que se les proporcione el Software a hacer lo mismo, sujeto a las siguientes condiciones:
El aviso de copyright anterior y este aviso de permiso se incluirán en todas las copias o partes sustanciales del Software.

EL SOFTWARE SE PROPORCIONA "COMO ESTÁ", SIN GARANTÍA DE NINGÚN TIPO, EXPRESA O IMPLÍCITA, INCLUYENDO PERO NO LIMITADO A GARANTÍAS DE COMERCIALIZACIÓN, IDONEIDAD PARA UN PROPÓSITO PARTICULAR E INCUMPLIMIENTO. EN NINGÚN CASO LOS AUTORES O PROPIETARIOS DE LOS DERECHOS DE AUTOR SERÁN RESPONSABLES DE NINGUNA RECLAMACIÓN, DAÑOS U OTRAS RESPONSABILIDADES, YA SEA EN UNA ACCIÓN DE CONTRATO, AGRAVIO O CUALQUIER OTRO MOTIVO, DERIVADAS DE, FUERA DE O EN CONEXIÓN CON EL SOFTWARE O SU USO U OTRO TIPO DE ACCIONES EN EL SOFTWARE.


